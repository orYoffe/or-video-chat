<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Or Video Chat</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.0.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.0.0/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-database.js"></script>
    <!-- 
    <script defer src="/__/firebase/8.0.0/firebase-firestore.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-functions.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-storage.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-remote-config.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-performance.js"></script> -->
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <script src="https://unpkg.com/simple-peer@9.8.0/simplepeer.min.js"></script>
    <style media="screen">
      body {
        background: #eceff1;
        color: rgba(0, 0, 0, 0.87);
        font-family: Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        position: fixed;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }
      .link-home {
        background-color: #eceff1;
        position: fixed;
        left: 10;
        top: 10;
        z-index: 9999;
      }
      .fullscreen {
        position: fixed;
        left: 50%;
        top: 10;
        z-index: 9999;
      }
      .video-self {
        width: 130px;
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
      }
      .video-call {
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }
      .chat-link {
        margin-right: 20px;
      }
    </style>
  </head>
  <body>
    <!-- <label>Enter Message:</label><br />
        <textarea id="yourMessage"></textarea>
        <button id="send">send</button>
        <pre id="messages"></pre> -->
    <div class="container">
      <div class="start-call" style="display: none">
      <div class="link-container" style="display: none">
        <label>Chat link:</label>
        <br />
        <input id="yourId" onfocus="this.select();" onmouseup="return false;" />
        <button id="copy-link">Copy link</button>
      </div>
      <ul class="channels"></ul>
      <a href="/" class="link-home" style="display: none">Go home</a>
      <button class="fullscreen" style="display: none">Fullscreen</button>
      <video class="video-call" autoplay></video>
      <video class="video-self" autoplay muted></video>
    </div>
    <script>
      function togglefullscreen(elem) {
        var isInFullScreen =
          (document.fullscreenElement && document.fullscreenElement !== null) ||
          (document.webkitFullscreenElement &&
            document.webkitFullscreenElement !== null) ||
          (document.mozFullScreenElement &&
            document.mozFullScreenElement !== null) ||
          (document.msFullscreenElement &&
            document.msFullscreenElement !== null);

        if (!isInFullScreen) {
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullScreen) {
            elem.webkitRequestFullScreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }
      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand("copy");
          var msg = successful ? "successful" : "unsuccessful";
          console.log("Fallback: Copying text command was " + msg);
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
        }

        document.body.removeChild(textArea);
      }
      function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
          fallbackCopyTextToClipboard(text);
          return;
        }
        navigator.clipboard.writeText(text).then(
          function () {
            // console.log('Async: Copying to clipboard was successful!');
          },
          function (err) {
            console.error("Async: Could not copy text: ", err);
          }
        );
      }

      async function paste(input) {
        const text = await navigator.clipboard.readText();
        input.value = text;
      }

      function play(selector, stream, shouldHaveControls) {
        var video = document.querySelector(selector);
        // video.controls = !!shouldHaveControls;
        if (typeof video.srcObject == "object") {
          video.srcObject = stream;
        } else {
          video.src = window.URL.createObjectURL(stream);
        }
      }
      document.addEventListener("DOMContentLoaded", async function () {
        const app = firebase.app();
        let uidCallback;
        let uid;
        let chatLink;
        let channelsView = document.querySelector(".channels");
        let name = window.localStorage.getItem("name");
          let linkContainer = document.querySelector(".link-container");

        const urlParams = new URLSearchParams(window.location.search);
        const callID = urlParams.get("id");

        function setInCallUI() {
          let linkhome = document.querySelector(".link-home");
          let fullscreen = document.querySelector(".fullscreen");

          channelsView.style.display = "none";
          linkContainer.style.display = "none";
          linkhome.style.display = "block";

          fullscreen.addEventListener("click", function () {
            togglefullscreen(document.querySelector(".container"));
          });
          fullscreen.style.display = "block";
        }
        if (callID) {
          setInCallUI();
        } else {
          firebase
            .database()
            .ref("offer/")
            .on("value", function (snapshot) {
              const channels = snapshot.val();
              channelsView.innerHTML = "";

              console.log("------------channels------------", channels);
              if (!channels) {
                return;
              }
              Object.keys(channels).forEach((key) => {
                if (channels[key].name === name) {
                  return;
                }
                const anchor = document.createElement("a");
                anchor.href = "/?id=" + key;
                anchor.className = "chat-link";
                anchor.textContent = channels[key].name;
                channelsView.appendChild(anchor);
              });
            });
        }

        if (!name) {
          name = prompt("Please enter your name", "John Doe");
          name = name
            ? name
            : "John Doe" + Math.random().toFixed(2) + Date.now();

          window.localStorage.setItem("name", name);
        }

          navigator.mediaDevices
            .getUserMedia({
              video: true,
              audio: true,
            })
            .then(function (stream) {
              
              play(".video-self", stream);
        console.log("------------name------------", name);
        function loggedInCallback() {
              var peer = new SimplePeer({
                initiator: !callID,
                trickle: false,
                stream: stream,
              });
              function assignToCallId(data) {
                const ref = firebase.database().ref("answer/" + callID);
                ref.set({
                  sdp: data.sdp,
                  type: data.type,
                  name,
                });
                ref.onDisconnect().remove(function (err) {
                  if (err) {
                    console.error(
                      "could not establish onDisconnect event",
                      err
                    );
                  }
                });
                // window.addEventListener(
                //   "beforeunload",
                //   function removeFromRoom() {
                //     firebase
                //       .database()
                //       .ref("answer/" + callID)
                //       .remove();
                //   }
                // );
              }


              peer.on("signal", async function (data) {
                console.log("------------data.type------------", data.type);
                if (callID ? data.type !== "answer" : data.type !== "offer") {
                  return;
                }
                if (callID) {
                  assignToCallId(data);
                } else {
                  const ref = firebase.database().ref("offer/" + uid);
                  await ref.set({ type: data.type, sdp: data.sdp, name });

                  ref.onDisconnect().remove(function (err) {
                    if (err) {
                      console.error(
                        "could not establish onDisconnect event",
                        err
                      );
                    }
                  });
                  // window.addEventListener(
                  //   "beforeunload",
                  //   function removeFromPeer() {
                  //     firebase
                  //       .database()
                  //       .ref("offer/" + uid)
                  //       .remove();
                  //   }
                  // );
                  await firebase
                    .database()
                    .ref("answer/" + uid)
                    .remove();
                  firebase
                    .database()
                    .ref("answer/" + uid)
                    .on("value", function (snapshot) {
                      const otherUser = snapshot.val();
                      console.log(
                        "------------otherUser------------",
                        otherUser
                      );
                      if (otherUser) {
                        // const keys = Object.keys(others);
                        // const user = others[keys[keys.length - 1]];
                        // console.log(
                        //   "-------others-----user------------",
                        //   user
                        // );
                        if (otherUser.type === "answer") {
                          try {
                            peer.signal({
                              sdp: otherUser.sdp,
                              type: otherUser.type,
                            });
                          } catch (error) {
                            console.log(
                              "------------error.message------------",
                              error.message
                            );
                            if (
                              "cannot signal after peer is destroyed" ===
                              error.message
                            ) {
                              window.location.reload();
                            }
                            // loggedInCallback();
                          }
                        }
                      }
                    });
                }
              });

              document
                .getElementById("copy-link")
                .addEventListener("click", function () {
                  console.log("------------chatLink------------", chatLink);
                  copyTextToClipboard(chatLink);
                });

              peer.on("data", function (data) {
                console.log("------------data------------", data);
              });

              peer.on("stream", function (remoteStream) {
                var video = document.querySelector(".video-call");

                play(".video-call", remoteStream, true);
                setInCallUI();
                // openFullscreen(document.querySelector(".container"));
              });
              peer.on("error", (err) => {
                console.log("----peer err.message: ", err.message);
                console.log("----peer error: ", err);
                if (err.code === "ERR_DATA_CHANNEL") {
                  play(".video-call", null);
                } else if (err.message === "Connection failed.") {
                  window.location.assign("/");
                }
                // loggedInCallback();
                // window.location.reload();
              });
              if (callID) {
                firebase
                  .database()
                  .ref("offer/" + callID)
                  .on("value", function (snapshot) {
                    const user = snapshot.val();
                    console.log("------callID------user------------", user);
                    if (!user) {
                      window.location.assign("/");
                      return;
                    }
                    try {
                      if (user.type === "offer") {
                        peer.signal({ sdp: user.sdp, type: user.type });
                      }
                    } catch (error) {
                      console.log("------------error------------", error);
                      // play(".video-call", null);
                      // loggedInCallback();
                      window.location.reload();
                    }
                    // firebase
                    //   .database()
                    //   .ref("offer/" + callID + "/others/" + uid)
                    //   .on("value", function (snapshot) {
                    //     const myself = snapshot.val();
                    //     console.log("------------myself------------", myself);
                    // if (!myself) {
                    // TODO need to reload
                    // loggedInCallback();
                    // }
                    // });
                  });
              }
        }
        
            })
            .catch(function (err) {
              console.log("Failed to get local stream", err);
              window.location.assign("/");
            });

        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            // User is signed in.
            // var isAnonymous = user.isAnonymous;
            uid = user.uid;
            chatLink =
              window.location.origin + window.location.pathname + "?id=" + uid;
            document.getElementById("yourId").value = chatLink;
            if (callID) {
            loggedInCallback();
            } else {
              
          let startCall = document.querySelector(".start-call");
          startCall.addEventListener('click', function () {
linkContainer.style.display= 'block';
            loggedInCallback();
            startCall.parentElement.removeChild(startCall)
          })
            }
          } else {
            // User is signed out.
            // ...
          }
          // ...
        });

        firebase.auth().signInAnonymously();
      });
    </script>
  </body>
</html>
