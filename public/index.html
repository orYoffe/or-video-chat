<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Or Video Chat</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.0.0/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.0.0/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-database.js"></script>
    <!-- 
    <script defer src="/__/firebase/8.0.0/firebase-firestore.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-functions.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-messaging.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-storage.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-remote-config.js"></script>
    <script defer src="/__/firebase/8.0.0/firebase-performance.js"></script> -->
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <script src="https://unpkg.com/simple-peer@9.8.0/simplepeer.min.js"></script>
    <style media="screen">
      body {
        background: #eceff1;
        color: rgba(0, 0, 0, 0.87);
        font-family: Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        position: fixed;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
      }
      .link-home {
        background-color: #eceff1;
        position: fixed;
        left: 10;
        top: 10;
        z-index: 9999;
      }
      .fullscreen {
        position: fixed;
        left: 50%;
        top: 10;
        z-index: 9999;
      }
      .video-self {
        width: 130px;
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
      }
      .video-call {
        position: absolute;
        right: 0;
        top: 0;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        display: none;
        flex-wrap: wrap;
        flex-wrap: wrap;
        flex-direction: row;
        align-items: stretch;
      }
      .video-call div {
        min-width: 250px;
        max-width: 100%;
        width: 100%;
        height: auto;
      }
      .video-call div video {
        max-width: 100%;
        max-height: 100%;
        width: 100%;
      }
      .chat-link {
        margin-right: 20px;
      }
    </style>
    <script>
      function togglefullscreen(elem) {
        var isInFullScreen =
          (document.fullscreenElement && document.fullscreenElement !== null) ||
          (document.webkitFullscreenElement &&
            document.webkitFullscreenElement !== null) ||
          (document.mozFullScreenElement &&
            document.mozFullScreenElement !== null) ||
          (document.msFullscreenElement &&
            document.msFullscreenElement !== null);

        if (!isInFullScreen) {
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.webkitRequestFullScreen) {
            elem.webkitRequestFullScreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }
      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand("copy");
          var msg = successful ? "successful" : "unsuccessful";
          console.log("Fallback: Copying text command was " + msg);
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
        }

        document.body.removeChild(textArea);
      }
      function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
          fallbackCopyTextToClipboard(text);
          return;
        }
        navigator.clipboard.writeText(text).then(
          function () {
            // console.log('Async: Copying to clipboard was successful!');
          },
          function (err) {
            console.error("Async: Could not copy text: ", err);
          }
        );
      }

      async function paste(input) {
        const text = await navigator.clipboard.readText();
        input.value = text;
      }

      function play(selector, stream, shouldHaveControls) {
        var video =
          typeof selector === "string"
            ? document.querySelector(selector)
            : selector;
        // video.controls = !!shouldHaveControls;
        if (typeof video.srcObject == "object") {
          video.srcObject = stream;
        } else {
          video.src = window.URL.createObjectURL(stream);
        }
      }

      function setInCallUI() {
        let videoWrapper = document.querySelector(".video-call");
        let linkhome = document.querySelector(".link-home");
        let fullscreen = document.querySelector(".fullscreen");
        let channelsView = document.querySelector(".channels");
        let linkContainer = document.querySelector(".link-container");

        channelsView.style.display = "none";
        linkContainer.style.display = "none";
        linkhome.style.display = "block";
        videoWrapper.style.display = "flex";

        fullscreen.addEventListener("click", function () {
          togglefullscreen(document.querySelector(".container"));
        });
        fullscreen.style.display = "block";
      }
    </script>
  </head>
  <body>
    <!-- <label>Enter Message:</label><br />
        <textarea id="yourMessage"></textarea>
        <button id="send">send</button>
        <pre id="messages"></pre> -->
    <div class="container">
      <button class="start-call" style="display: none">Start a call</button>
      <div class="link-container" style="display: none">
        <label>Chat link:</label>
        <br />
        <input id="yourId" onfocus="this.select();" onmouseup="return false;" />
        <button id="copy-link">Copy link</button>
      </div>
      <ul class="channels"></ul>
      <a href="/" class="link-home" style="display: none">Go home</a>
      <button class="fullscreen" style="display: none">Fullscreen</button>
      <div class="video-call"></div>
      <!-- <video class="video-call" autoplay></video> -->
      <video class="video-self" autoplay muted></video>
    </div>
    <script>
      const roomId = window.location.pathname.slice(1);
      document.addEventListener("DOMContentLoaded", async function () {
        const chatLink = window.location.origin + window.location.pathname;
        document.getElementById("yourId").value = chatLink;

        document
          .getElementById("copy-link")
          .addEventListener("click", function () {
            copyTextToClipboard(chatLink);
          });

        const app = firebase.app();
        let uid;
        let name = window.localStorage.getItem("name");

        if (!name) {
          name = prompt("Please enter your name", "John Doe");
          name = name ? name : "John " + Math.random().toFixed(2) + Date.now();

          window.localStorage.setItem("name", name);
        }
        console.log("------------name------------", name);

        let selfStream;
        if (roomId) {
          try {
            selfStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });
            play(".video-self", selfStream);
          } catch (error) {
            console.log(" ****** Failed to get local stream: ", error);
            window.location.assign("/");
          }
        }
        function createPeer(isAnswer) {
          const peer = new SimplePeer({
            initiator: !isAnswer,
            trickle: false,
            stream: selfStream,
          });

          let peerVideoTag;
          const videoWrapper = document.querySelector(".video-call");

          peer.on("stream", function (remoteStream) {
            peerVideoTag = document.createElement("div");
            const video = document.createElement("video");
            video.autoplay = true;
            play(video, remoteStream);
            peerVideoTag.appendChild(video);
            videoWrapper.appendChild(peerVideoTag);
            setInCallUI();
          });

          peer.on("error", (err) => {
            console.log("----peer err.message: ", err.message);
            console.log("----peer error: ", err);
            if (err.code === "ERR_DATA_CHANNEL") {
              videoWrapper.removeChild(peerVideoTag);
            } else if (err.message === "Connection failed.") {
              videoWrapper.removeChild(peerVideoTag);
            }
          });
          peer.on("data", function (data) {
            console.log("------------data------------", data);
          });

          return peer;
        }

        function makePeer(userData, otherUserId) {
          const isAnswer = !!userData;
          const peer = createPeer(isAnswer);

          if (isAnswer) {
            peer.on("signal", async function (data) {
              console.log("----------ANSWER------------");
              console.log(
                "--ANSWER----signal------isAnswer------------",
                isAnswer
              );
              console.log(
                "--ANSWER----signal------userData------------",
                userData
              );
              console.log("--ANSWER-----signal-----data------------", data);
              console.log("----------ANSWER------------");
              if (data.type !== "answer") {
                return;
              }
              const ref = firebase
                .database()
                .ref("users/" + otherUserId + "/" + uid);
              await ref.set({ type: data.type, sdp: data.sdp, name });

              ref.onDisconnect().remove(function (err) {
                if (err) {
                  console.error("could not establish onDisconnect event", err);
                }
              });
            });

            peer.signal({
              sdp: userData.sdp,
              type: userData.type,
            });
          } else {
            peer.on("signal", async function (data) {
              console.log("----------OFFER------------");
              console.log(
                "--OFFER---signal-------isAnswer------------",
                isAnswer
              );
              console.log(
                "--OFFER---signal-------userData------------",
                userData
              );
              console.log("--OFFER---signal-------data------------", data);
              console.log("----------OFFER------------");
              if (data.type !== "offer") {
                return;
              }
              const ref = firebase
                .database()
                .ref("users/" + otherUserId + "/" + uid);
              await ref.set({ type: data.type, sdp: data.sdp, name });

              ref.onDisconnect().remove(function (err) {
                if (err) {
                  console.error("could not establish onDisconnect event", err);
                }
              });
            });
          }
          return peer;
        }
        firebase.auth().onAuthStateChanged(async function (user) {
          if (!user) {
            console.log(
              "----user  not connected--------user------------",
              user
            );
            return;
          }

          uid = user.uid;

          if (roomId) {
            setInCallUI();

            // User domain
            const userDomain = firebase.database().ref("users/" + uid);
            userDomain.remove(function (err) {
              if (err) {
                console.error("could not establish onDisconnect event", err);
              }
            });
            userDomain.onDisconnect().remove(function (err) {
              if (err) {
                console.error("could not establish onDisconnect event", err);
              }
            });
            const peers = {};

            userDomain.on("child_added", function (snapshot) {
              let offer = snapshot.val();
              const dataRef = snapshot.ref;
              const userId = snapshot.key.slice(0);
              // console.log("------------dataRef------------", dataRef);
              console.log("------child_added------userId------------", userId);
              console.log("-----child_added-------offer------------", offer);

              if (!offer) {
                return;
              }
              offer = { ...offer };
              if (offer.type === "offer") {
                const peer = makePeer(offer, userId);
                peers[userId] = peer;
              } else if (peers[userId]) {
                peers[userId].signal({
                  sdp: offer.sdp,
                  type: offer.type,
                });
              }
              // TODO remove child after taking action
              dataRef.remove(function (err) {
                if (err) {
                  console.error("could not establish onDisconnect event", err);
                }
              });
            });

            // Room domain
            const roomRef = firebase.database().ref("rooms/" + roomId);
            await roomRef.once("value", function (snapshot) {
              const room = snapshot.val();
              console.log("------------room------------", room);
              if (room) {
                Object.keys(room).forEach((userId) => {
                  if (userId !== uid) {
                    const peer = makePeer(null, userId);
                    peers[userId] = peer;
                  }
                });
              }
              const userRoom = firebase
                .database()
                .ref("rooms/" + roomId + "/" + uid);

              userRoom.set({ uid });

              userRoom.onDisconnect().remove(function (err) {
                if (err) {
                  console.error("could not establish onDisconnect event", err);
                }
              });
            });
          } else {
            let startCall = document.querySelector(".start-call");
            startCall.style.display = "block";
            startCall.addEventListener("click", function () {
              let linkContainer = document.querySelector(".link-container");
              linkContainer.style.display = "block";
              startCall.parentElement.removeChild(startCall);
              window.location.assign("/room-" + name);
            });

            firebase
              .database()
              .ref("rooms/")
              .on("value", function (snapshot) {
                const rooms = snapshot.val();
                let channelsView = document.querySelector(".channels");
                channelsView.innerHTML = "";

                console.log("------------rooms------------", rooms);
                if (!rooms) {
                  return;
                }
                channelsView.innerHTML = "Rooms: <br/>";
                Object.keys(rooms).forEach((key) => {
                  if (rooms[key].name === name) {
                    return;
                  }
                  const anchor = document.createElement("a");
                  anchor.href = "/" + key;
                  anchor.className = "chat-link";
                  anchor.textContent = decodeURI(key);
                  channelsView.appendChild(anchor);
                });
              });
          }
        });

        firebase.auth().signInAnonymously();
      });
    </script>
  </body>
</html>
